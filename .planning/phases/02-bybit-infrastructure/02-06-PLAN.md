---
phase: 02-bybit-infrastructure
plan: 06
type: execute
wave: 3
depends_on:
  - "02-04"
  - "02-05"
files_modified:
  - internal/driver/bybit/driver.go
  - pkg/driver/driver.go
autonomous: true

must_haves:
  truths:
    - "Driver implements pkg/driver.Driver interface"
    - "Identical method signatures to Binance driver"
    - "Factory function creates configured driver instances"
    - "REST and WebSocket clients are wired together"
  artifacts:
    - path: "internal/driver/bybit/driver.go"
      provides: "Bybit driver implementation"
      exports: ["New", "Driver"]
      min_lines: 200
    - path: "pkg/driver/driver.go"
      provides: "Formal Driver interface"
      exports: ["Driver", "OrderResult", "CancelResult"]
  key_links:
    - from: "pkg/driver.Driver"
      to: "bybit.Driver"
      via: "interface implementation"
      pattern: "identical signatures to binance"
---

<objective>
Create formal Driver interface and Bybit driver implementation.

Purpose: Define the exchange driver contract and implement it for Bybit, enabling easy exchange switching.
Output: pkg/driver/driver.go (interface) and internal/driver/bybit/driver.go (implementation).
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-bybit-infrastructure/02-RESEARCH.md
@.planning/phases/02-bybit-infrastructure/02-CONTEXT.md

# Dependencies from Wave 2
@.planning/phases/02-bybit-infrastructure/02-04-SUMMARY.md
@.planning/phases/02-bybit-infrastructure/02-05-SUMMARY.md

# Domain types
@pkg/domain/types.go
@pkg/domain/decimal.go
@pkg/errors/errors.go
</context>

<tasks>

<task type="auto">
  <name>Create formal Driver interface</name>
  <files>pkg/driver/driver.go</files>
  <action>
    Create pkg/driver/driver.go defining the exchange driver interface.

    This formal interface enables compiler enforcement of consistent signatures
    across Binance and Bybit drivers.

    Driver interface methods:

    // Connection management
    Connect(ctx context.Context) error
    Disconnect() error
    Close() error
    IsConnected() bool

    // Market data
    GetServerTime(ctx context.Context) (int64, error)
    GetExchangeInfo(ctx context.Context) (*ExchangeInfo, error)
    GetTicker(ctx context.Context, symbol string) (*domain.Ticker, error)
    GetOrderbook(ctx context.Context, symbol string, depth int) (*domain.OrderBook, error)

    // WebSocket subscriptions
    SubscribeTicker(symbol string, handler func(*domain.Ticker)) (unsubscribe func(), err error)
    SubscribeOrderbook(symbol string, depth int, handler func(*domain.OrderBook)) (unsubscribe func(), err error)
    SubscribeTrades(symbol string, handler func(*domain.Trade)) (unsubscribe func(), err error)

    // Account
    GetAccount(ctx context.Context) (*AccountInfo, error)
    GetBalances(ctx context.Context) ([]domain.Balance, error)

    // Orders
    PlaceOrder(ctx context.Context, req *domain.OrderRequest) (*domain.Order, error)
    CancelOrder(ctx context.Context, req *domain.CancelRequest) error
    GetOrder(ctx context.Context, symbol, orderID string) (*domain.Order, error)
    GetOpenOrders(ctx context.Context, symbol string) ([]*domain.Order, error)

    // Utilities
    Name() string  // Returns "binance" or "bybit"
    SyncTime(ctx context.Context) error

    Supporting types:
    - ExchangeInfo (common fields from both exchanges)
    - AccountInfo (common fields)
    - OrderResult (result of place order)
    - CancelResult (result of cancel order)

    Add documentation comments explaining the interface contract.
  </action>
  <verify>go build ./pkg/driver/... succeeds without errors</verify>
  <done>pkg/driver/driver.go exists with Driver interface and supporting types</done>
</task>

<task type="auto">
  <name>Create Bybit driver implementation</name>
  <files>internal/driver/bybit/driver.go</files>
  <action>
    Create internal/driver/bybit/driver.go implementing pkg/driver.Driver.

    Driver struct:
    - config Config
    - rest *RESTClient
    - ws *WSClient
    - name string = "bybit"
    - mu sync.RWMutex

    Config struct (reuse from rest_client with additions):
    - BaseURL, APIKey, APISecret, Timeout, RecvWindow, Testnet
    - WSConfig (embedded)

    New(cfg Config) (*Driver, error):
    - Create RESTClient
    - Create WSClient
    - Wire callbacks
    - Return driver instance

    Implement all Driver interface methods:

    Connection:
    - Connect(ctx) - start WebSocket connection
    - Disconnect() - disconnect WebSocket
    - Close() - close both clients
    - IsConnected() - return WebSocket state

    Market data (REST):
    - GetServerTime(ctx) - use rest.GetServerTime()
    - GetExchangeInfo(ctx) - use rest.GetExchangeInfo()
    - GetTicker(ctx, symbol) - call /v5/market/tickers with category=spot
    - GetOrderbook(ctx, symbol, depth) - call /v5/market/orderbook

    WebSocket subscriptions:
    - SubscribeTicker(symbol, handler) - use ws.Subscribe with topic builder
    - SubscribeOrderbook(symbol, depth, handler) - use orderbook.{depth}.{symbol}
    - SubscribeTrades(symbol, handler) - use publicTrade.{symbol}
    - Return unsubscribe functions

    Account:
    - GetAccount(ctx) - use rest.GetAccount()
    - GetBalances(ctx) - extract from account info

    Orders:
    - PlaceOrder(ctx, req) - call /v5/order/create with category=spot
    - CancelOrder(ctx, req) - call /v5/order/cancel
    - GetOrder(ctx, symbol, orderID) - call /v5/order/realtime
    - GetOpenOrders(ctx, symbol) - call /v5/order/realtime with openOnly=true

    Utilities:
    - Name() - return "bybit"
    - SyncTime(ctx) - use rest.SyncTime()

    Key implementation notes:
    - Symbol conversion: domain format "BTC/USDT" -> Bybit format "BTCUSDT"
    - category=spot must be in all spot requests
    - Error mapping from Bybit codes to domain errors
    - Thread-safe operations with mutex

    Add comprehensive documentation comments.
  </action>
  <verify>go build ./internal/driver/bybit/... && go vet ./internal/driver/bybit/...</verify>
  <done>driver.go exists implementing pkg/driver.Driver interface</done>
</task>

</tasks>

<verification>
1. Driver interface compiles
2. Bybit Driver implements all interface methods
3. go vet passes
4. Method signatures match interface exactly
</verification>

<success_criteria>
- pkg/driver/driver.go defines Driver interface
- internal/driver/bybit/driver.go implements Driver
- All interface methods have implementations
- Symbol conversion handled correctly
- Code compiles and passes vet
</success_criteria>

<output>
After completion, create `.planning/phases/02-bybit-infrastructure/02-06-SUMMARY.md`
</output>
