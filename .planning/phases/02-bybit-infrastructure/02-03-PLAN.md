---
phase: 02-bybit-infrastructure
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - internal/driver/bybit/subscription.go
autonomous: true

must_haves:
  truths:
    - "Subscription manager tracks active WebSocket topics"
    - "StreamBuilder generates correct Bybit topic names"
    - "Topics can be retrieved for resubscription on reconnect"
  artifacts:
    - path: "internal/driver/bybit/subscription.go"
      provides: "Subscription management and topic builders"
      exports: ["SubscriptionManager", "StreamBuilder", "NewStreamBuilder"]
      min_lines: 150
  key_links:
    - from: "StreamBuilder"
      to: "Bybit topic format"
      via: "topic string generation"
      pattern: "orderbook.50.{symbol}, publicTrade.{symbol}, tickers.{symbol}"
---

<objective>
Create subscription manager and stream builder for Bybit WebSocket topics.

Purpose: Track subscriptions for automatic resubscription and generate properly formatted Bybit topic names.
Output: subscription.go with SubscriptionManager and StreamBuilder.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-bybit-infrastructure/02-RESEARCH.md
@.planning/phases/02-bybit-infrastructure/02-CONTEXT.md

# Reference implementation from Phase 1
@internal/driver/binance/subscription.go

# Key Bybit differences (from RESEARCH.md):
# - Topic format: orderbook.50.BTCUSDT, publicTrade.BTCUSDT, tickers.BTCUSDT
# - UPPERCASE symbols (not lowercase like Binance)
# - Dynamic subscribe/unsubscribe IS supported (no reconnection needed for new subs)
# - Subscription message: {"op":"subscribe","args":["tickers.BTCUSDT"]}
</context>

<tasks>

<task type="auto">
  <name>Create subscription manager and stream builder</name>
  <files>internal/driver/bybit/subscription.go</files>
  <action>
    Create internal/driver/bybit/subscription.go adapting the Binance pattern for Bybit.

    SubscriptionManager struct:
    - Same thread-safe pattern as Binance (sync.RWMutex)
    - mu sync.RWMutex
    - subscriptions map[string]bool
    - Methods: Subscribe, Unsubscribe, IsSubscribed, Streams, Count, Clear

    Key difference from Binance:
    - Bybit topics are UPPERCASE (e.g., "tickers.BTCUSDT")
    - Do NOT call strings.ToLower() - keep original case

    StreamBuilder struct:
    - symbol string (exchange format, e.g., "BTCUSDT")
    - NewStreamBuilder(symbol string) *StreamBuilder

    StreamBuilder methods:
    - Ticker() string - returns "tickers.{symbol}"
    - Orderbook(depth int) string - returns "orderbook.{depth}.{symbol}"
      - Common depths: 1, 50, 200, 500
    - Orderbook50() string - convenience for "orderbook.50.{symbol}"
    - Trade() string - returns "publicTrade.{symbol}"
    - Kline(interval string) string - returns "kline.{interval}.{symbol}"

    Helper functions:
    - ParseTopicSymbol(topic string) string - extracts symbol from topic
    - ParseTopicType(topic string) string - extracts topic type (orderbook, tickers, etc.)

    Add documentation comments referencing:
    - https://bybit-exchange.github.io/docs/v5/ws/public

    CRITICAL: Topics must be UPPERCASE (unlike Binance which requires lowercase).
  </action>
  <verify>go build ./internal/driver/bybit/... succeeds without errors</verify>
  <done>subscription.go exists with SubscriptionManager and StreamBuilder generating correct topic format</done>
</task>

</tasks>

<verification>
1. SubscriptionManager is thread-safe
2. StreamBuilder generates correct Bybit topic format
3. Topics use UPPERCASE symbols
4. ParseTopicSymbol and ParseTopicType work correctly
</verification>

<success_criteria>
- subscription.go defines SubscriptionManager with thread-safe methods
- subscription.go defines StreamBuilder with topic generation methods
- Topic format matches Bybit specification
- Code compiles successfully
</success_criteria>

<output>
After completion, create `.planning/phases/02-bybit-infrastructure/02-03-SUMMARY.md`
</output>
