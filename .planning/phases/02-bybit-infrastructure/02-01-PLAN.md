---
phase: 02-bybit-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - internal/driver/bybit/urls.go
  - internal/driver/bybit/signer.go
autonomous: true

must_haves:
  truths:
    - "Bybit REST and WebSocket URLs are correctly defined for production and testnet"
    - "Signer generates valid X-BAPI-* headers for authenticated requests"
    - "Signature format matches Bybit specification: timestamp+apiKey+recvWindow+payload"
  artifacts:
    - path: "internal/driver/bybit/urls.go"
      provides: "API endpoints and base URLs"
      min_lines: 40
    - path: "internal/driver/bybit/signer.go"
      provides: "HMAC-SHA256 signing with Bybit format"
      exports: ["NewSigner", "Signer.Sign", "Signer.APIKey"]
  key_links:
    - from: "signer.Sign()"
      to: "X-BAPI-SIGN header"
      via: "HMAC-SHA256"
      pattern: "hex.EncodeToString"
---

<objective>
Create foundation files for Bybit driver: URL constants and authentication signer.

Purpose: Establish base URLs for REST and WebSocket connections, and implement Bybit-specific signature format that differs from Binance.
Output: Two files (urls.go, signer.go) that all other Bybit components depend on.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-bybit-infrastructure/02-RESEARCH.md
@.planning/phases/02-bybit-infrastructure/02-CONTEXT.md

# Reference implementation from Phase 1
@internal/driver/binance/urls.go
@internal/driver/binance/signer.go

# Key differences from Binance (from RESEARCH.md):
# - Headers: X-BAPI-API-KEY, X-BAPI-TIMESTAMP, X-BAPI-SIGN, X-BAPI-RECV-WINDOW
# - Signature: timestamp + apiKey + recvWindow + payload (concatenated, NOT query string only)
# - All spot endpoints require category=spot parameter
</context>

<tasks>

<task type="auto">
  <name>Create Bybit URL constants and endpoints</name>
  <files>internal/driver/bybit/urls.go</files>
  <action>
    Create internal/driver/bybit/urls.go following the pattern from internal/driver/binance/urls.go but with Bybit-specific values:

    Base URLs:
    - Production REST: https://api.bybit.com
    - Production WebSocket: wss://stream.bybit.com/v5/public/spot
    - Testnet REST: https://api-testnet.bybit.com
    - Testnet WebSocket: wss://stream-testnet.bybit.com/v5/public/spot

    REST endpoints (V5 API):
    - EPing = "/v5/market/time" (server time)
    - ETickers = "/v5/market/tickers" (ticker info)
    - EOrderbook = "/v5/market/orderbook" (order book)
    - EInstruments = "/v5/market/instruments-info" (symbol info)
    - ECreateOrder = "/v5/order/create"
    - ECancelOrder = "/v5/order/cancel"
    - EQueryOrder = "/v5/order/realtime"
    - EOpenOrders = "/v5/order/realtime" (with openOnly=true)
    - EWalletBalance = "/v5/account/wallet-balance"

    Rate limits map (requests per second, NOT weight-based like Binance):
    - Order endpoints: 20/s
    - Account endpoints: 10/s
    - Query endpoints: 50/s

    Include GetEndpointRateLimit(endpoint string) int function returning the per-second limit.
    Default to 10/s for unknown endpoints (conservative).

    Add comprehensive documentation comments with Bybit API v5 documentation URLs.
  </action>
  <verify>go build ./internal/driver/bybit/... succeeds without errors</verify>
  <done>urls.go exists with all endpoints defined, GetEndpointRateLimit function returns correct limits</done>
</task>

<task type="auto">
  <name>Create Bybit authentication signer</name>
  <files>internal/driver/bybit/signer.go</files>
  <action>
    Create internal/driver/bybit/signer.go implementing Bybit-specific signature format.

    Key differences from Binance (CRITICAL):
    1. Binance signs: HMAC(queryString)
    2. Bybit signs: HMAC(timestamp + apiKey + recvWindow + payload)
       - For GET: timestamp + apiKey + recvWindow + queryString
       - For POST: timestamp + apiKey + recvWindow + jsonBodyString

    Signer struct fields:
    - apiKey string
    - apiSecret string
    - recvWindow int64 (default 5000, max 60000)

    Methods:
    - NewSigner(apiKey, apiSecret string, recvWindow int64) *Signer
    - Sign(method, queryString, body string) (timestamp int64, signature string)
      - Returns timestamp in milliseconds
      - Returns hex-encoded HMAC-SHA256 signature
    - APIKey() string (for X-BAPI-API-KEY header)
    - RecvWindow() int64 (for X-BAPI-RECV-WINDOW header)
    - ValidateCredentials() error

    Add documentation comments referencing:
    - https://bybit-exchange.github.io/docs/v5/guide
    - Signature format explanation in comments

    DO NOT copy Binance signer directly - the signature format is fundamentally different.
  </action>
  <verify>go build ./internal/driver/bybit/... && go test ./internal/driver/bybit/... -run TestSigner -v (if test exists)</verify>
  <done>signer.go exists, Sign() method produces correct signature format per Bybit specification</done>
</task>

</tasks>

<verification>
1. Both files compile without errors
2. Signer.Sign() generates signatures in correct Bybit format
3. All endpoint constants match Bybit V5 API documentation
4. Rate limits are per-second values (not weight-based)
</verification>

<success_criteria>
- urls.go defines production and testnet URLs
- urls.go defines all required REST endpoints
- urls.go defines per-second rate limit map
- signer.go implements Bybit signature format (concatenated string, not query string only)
- Code compiles successfully
</success_criteria>

<output>
After completion, create `.planning/phases/02-bybit-infrastructure/02-01-SUMMARY.md`
</output>
