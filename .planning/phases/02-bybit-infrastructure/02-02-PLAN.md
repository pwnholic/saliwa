---
phase: 02-bybit-infrastructure
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - internal/driver/bybit/ws_messages.go
autonomous: true

must_haves:
  truths:
    - "WebSocket messages parse correctly from Bybit streams"
    - "ToDomain() methods convert Bybit format to domain types"
    - "All price/quantity fields use Decimal type (no float64)"
  artifacts:
    - path: "internal/driver/bybit/ws_messages.go"
      provides: "WebSocket message types and domain conversion"
      exports: ["WSMessage", "WSTicker", "WSOrderbook", "WSTrade", "WSOrderUpdate"]
      min_lines: 300
  key_links:
    - from: "WSMessage.Data"
      to: "specific message types"
      via: "json.Unmarshal"
      pattern: "Topic field routing"
---

<objective>
Create WebSocket message types for Bybit with ToDomain() conversion methods.

Purpose: Define structs that map to Bybit WebSocket JSON messages and provide conversion to domain types.
Output: ws_messages.go with all message types and domain converters.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-bybit-infrastructure/02-RESEARCH.md
@.planning/phases/02-bybit-infrastructure/02-CONTEXT.md

# Reference implementation from Phase 1
@internal/driver/binance/ws_messages.go

# Domain types (from Phase 1)
@pkg/domain/types.go
@pkg/domain/decimal.go

# Key Bybit WebSocket differences (from RESEARCH.md):
# - Base message has Topic, Type (snapshot/delta), TS, Data fields
# - Topics: orderbook.50.{symbol}, publicTrade.{symbol}, tickers.{symbol}
# - Orderbook: S (symbol), B (bids), A (asks), U (update ID), Seq
# - Trade: T (timestamp), S (symbol), Sd (side), V (size), P (price), I (trade ID)
# - Ticker: symbol, lastPrice, bid1Price, ask1Price, volume24h, etc.
</context>

<tasks>

<task type="auto">
  <name>Create Bybit WebSocket message types</name>
  <files>internal/driver/bybit/ws_messages.go</files>
  <action>
    Create internal/driver/bybit/ws_messages.go following the pattern from binance/ws_messages.go but with Bybit-specific field names.

    Package declaration and documentation:
    - Package bybit implements the Bybit exchange driver
    - Reference: https://bybit-exchange.github.io/docs/v5/ws/public

    Message types to implement:

    1. WSMessage (base wrapper):
       - Topic string (e.g., "orderbook.50.BTCUSDT")
       - Type string ("snapshot" or "delta")
       - TS int64 (timestamp in milliseconds)
       - Data json.RawMessage

    2. WSTicker (ticker updates):
       - Symbol string
       - LastPrice string
       - HighPrice24h string
       - LowPrice24h string
       - Volume24h string
       - Turnover24h string (quote volume)
       - Bid1Price string
       - Bid1Size string
       - Ask1Price string
       - Ask1Size string
       - ToDomain(exchange string) (*domain.Ticker, error)

    3. WSOrderbookData (orderbook updates):
       - S string (symbol)
       - B [][]string (bids [[price, size], ...])
       - A [][]string (asks)
       - U int64 (update ID)
       - Seq int64 (sequence number)
       - ToDomain() (bids, asks []domain.OrderBookLevel, err error)

    4. WSTradeData (public trades):
       - T int64 (trade timestamp)
       - S string (symbol)
       - Sd string (side: "Buy" or "Sell")
       - V string (size)
       - P string (price)
       - I string (trade ID)
       - BT bool (block trade)
       - ToDomain(exchange string) (*domain.Trade, error)

    5. WSOrderUpdate (order updates - for user data stream):
       - orderId, orderLinkId, symbol, side, price, qty, orderStatus, etc.
       - ToDomain(exchange string) (*domain.Order, error)

    6. WSSubscription (for subscribe/unsubscribe):
       - ReqID string `json:"req_id,omitempty"`
       - Op string `json:"op"` // "subscribe" or "unsubscribe"
       - Args []string `json:"args"`

    7. WSPing/WSPong (heartbeat):
       - Op string `json:"op"` // "ping" or "pong"

    All ToDomain() methods must:
    - Use domain.NewDecimal() for all price/quantity conversions
    - Use domain.NormalizeSymbol() for symbol normalization
    - Handle parsing errors gracefully with wrapped errors
    - Return domain types (Ticker, Trade, Order, OrderBookLevel)

    Add documentation comments referencing Bybit API v5 documentation URLs.
  </action>
  <verify>go build ./internal/driver/bybit/... succeeds without errors</verify>
  <done>ws_messages.go exists with all message types and ToDomain() methods</done>
</task>

</tasks>

<verification>
1. All message types compile
2. ToDomain() methods return domain types
3. All price/quantity parsing uses domain.Decimal
4. No float64 usage in message types
</verification>

<success_criteria>
- ws_messages.go defines all required message types
- Each message type has ToDomain() method
- Decimal parsing handles errors properly
- Code compiles successfully
</success_criteria>

<output>
After completion, create `.planning/phases/02-bybit-infrastructure/02-02-SUMMARY.md`
</output>
